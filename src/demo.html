<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>drawCircleByManual</title>
</head>
<body>
<canvas id="myCanvas"></canvas>
<img src="./images/african_head_diffuse.png" id="textureImg" alt="" />
<script src="share/obj.js"></script>
<script>
    function main(){
        const w = 800;
        const h = 800;

        let canvas = document.getElementById("myCanvas");
        canvas.height = h;
        canvas.width = w;
        let context = canvas.getContext("2d");

        let pxData = context.getImageData(0,0,w,h);

        //drawCircle(pxData,centerX,centerY,radius);
        //drawCircle(pxData,centerX,centerY,radius);
        //drawLine(20,50,80,90,pxData,255,0,0,255);
        //drawLine(80,90,0,0,pxData,255,0,0,255);
        //drawTriangle2({x:180,y:80},{x:30,y:50},{x:100,y:10},pxData,[255,200,2,255])
        //drawTriangle({x:100,y:300},{x:300,y:50},{x:110,y:80},pxData,[255,0,2,255])

        //drawTriangle2({x:10,y:10},{x:100,y:30},{x:190,y:160},pxData,[255,200,2,255])


        //drawModel(pxData,w,h);
        //drawModel2(pxData,w,h);
        drawModel3(pxData,w,h);

        context.putImageData(pxData,0,0);

    }



    function drawLine(x1,y1,x2,y2,imageData,r,g,b,a){

        let swap = false;

        if(Math.abs(y2-y1) < Math.abs(x2-x1)){
            swap = true;
            let tx = x1;
            let ty = y1;
            x1 = y2;
            y1 = x2;
            y2 = tx;
            x2 = ty;
        }
        if(y1>y2){
            let tx = x1;
            let ty = y1;
            x1 = x2;
            y1 = y2;
            x2 = tx;
            y2 = ty;
        }

        let range = y2-y1;

        for(let y=y1;y<=y2;y++){
            let t = (y-y1)/range;
            let x = Math.round(x1+t*(x2-x1));
            if(swap){
                setPxColor(y,x,imageData,r,g,b,a)
            }else{
                setPxColor(x,y,imageData,r,g,b,a)
            }
        }
    }
    function drawCircle(imageData,centerX,centerY,radius){

        let ox = centerX;
        let oy = centerY;

        for(let i=0;i<=360;i++){
            let nA = Math.PI/180*i;

            let x = Math.ceil(centerX + radius * Math.sin(nA));
            let y = Math.ceil(centerY + radius * Math.cos(nA));
            drawLine(ox,oy,x,y,imageData,255,0,255,255);
            console.log(x,y)
            ox = x;
            oy = y;
        }
    }

    function drawTriangle(v1,v2,v3,imageData,colors){
        if(v1.y > v2.y){
            swapVec(v1,v2);
        }
        if(v1.y > v3.y){
            swapVec(v1,v3);
        }
        if(v2.y > v3.y){
            swapVec(v2,v3);
        }

        let range1 = v2.y - v1.y;
        let range2 = v3.y - v1.y;


        let w;
        for(let y=v1.y;y<=v2.y;y++){
            let a = (y-v1.y)/range1;
            let b = (y-v1.y)/range2;

            let dx1 = Math.round(v1.x + (v2.x-v1.x) * a);
            let dx2 = Math.round(v1.x + (v3.x-v1.x) * b);


            if(dx1 > dx2){
                let t = dx1;
                dx1 = dx2;
                dx2 = t;
            }
            w = dx2 - dx1;
            for(let j = dx1;j<=dx2;j++){
                setPxColor(j,y,imageData,...colors);
            }
        }


        let range3 = v3.y - v2.y;



        for(let y=v2.y;y<=v3.y;y++){
            let a = (y-v2.y)/range3;
            let b = (y-v1.y)/range2;


            let dx1 = Math.round(v2.x + (v3.x-v2.x)*a);
            let dx2 = Math.round(v1.x + (v3.x-v1.x)*b);

            if(dx1 > dx2){
                let t = dx1;
                dx1 = dx2;
                dx2 = t;
            }
            for(let j = dx1;j<=dx2;j++){
                setPxColor(j,y,imageData,...colors);
            }
        }

    }
    function drawTriangle2(v1,v2,v3,imageData,colors,zBuffer,textures){

        let w = imageData.width;
        let h = imageData.height;
        let minXY = [w-1,h-1];
        let maxXY = [0,0];
        let arr = [v1,v2,v3];
        const imgWH = [w-1,h-1]
        for(let i=0;i<arr.length;i++){
            let item = arr[i];

            for(let z=0;z<2;z++){
                let key;
                if(z === 0){
                    key = "x"
                }else{
                    key = "y";
                }

                minXY[z] = Math.max(0,Math.min(minXY[z],item[key]));
                maxXY[z] = Math.min(imgWH[z],Math.max(maxXY[z],item[key]));
            }
        }

        for(let x = minXY[0];x<maxXY[0];x++){
            for(let y = minXY[1];y<maxXY[1];y++){

                let bc = insideTriangle(v1,v2,v3,[x,y]);

                if(bc[0]<0 || bc[1]<0 || bc[2]<0){
                    continue
                }
                let z = 0;
                for(let i=0;i<3;i++){
                    z -= arr[i].z * bc[i];
                }
                let index = Number(x + y * imageData.width);
                if(typeof zBuffer[index] === "undefined" ||  zBuffer[index] < z){
                    zBuffer[index] = z;

                    setPxColor(x,y,imageData,...colors);

                }

            }
        }
    }

    function insideTriangle(a,b,c,P){
        let s = [
            [],[]
        ];

        for(let i=2;i--;){
            let key;
            if(i === 1){
                key = "y"
            }
            else{
                key = "x";
            }

            s[i][0] = c[key] - a[key];
            s[i][1] = a[key] - b[key];
            s[i][2] = a[key] - P[i];
        }

        let u = crossProduct(s[0],s[1]);

       if(Math.abs(u[2])<1){
            return [-1,1,1];
        }
        return [1 - (u[0] + u[1]) / u[2], u[1] / u[2], u[0] / u[2]];
    }

    function swapVec(a,b){
        let x = a.x;
        let y = a.y;
        a.x = b.x;
        a.y = b.y;
        b.x = x;
        b.y = y;
    }


    function setPxColor(x,y,imageData,r,g,b,a=255){
        let data = imageData.data;
        let w = imageData.width;

        let index = (w * y + x  ) * 4;

        data[index] = r;
        data[index+1] = g;
        data[index+2] = b;
        data[index+3] = a;
    }

    function drawModel(imageData,width,height){
        for(let i=0;i<objDataArray.faces.length;i++){
            let face = objDataArray.faces[i];

            for(let j=0;j<3;j++){
                let v0 = objDataArray.verts[face[j]];
                let v1 = objDataArray.verts[face[(j+1)%3]];

                let v0x =  Math.round((-v0[2]+1 ) * width / 2);
                let v0y =  Math.round((-v0[1]+1 ) * height / 2 );

                let v1x =  Math.round((-v1[2]+1) * width / 2);
                let v1y =  Math.round((-v1[1]+1) * height / 2);

                drawLine(v0x,v0y,v1x,v1y,imageData,255,255,255,255);
            }
        }
    }

    function drawModel2(imageData,width,height){
        for(let i=0;i<objDataArray.faces.length;i++){
            let face = objDataArray.faces[i];

            let v0 = objDataArray.verts[face[0]];
            let v1 = objDataArray.verts[face[(1)]];
            let v2 = objDataArray.verts[face[(2)]];

            let v0x =  Math.round((-v0[0]+1 ) * width / 2);
            let v0y =  Math.round((-v0[1]+1 ) * height / 2 );

            let v1x =  Math.round((-v1[0]+1) * width / 2);
            let v1y =  Math.round((-v1[1]+1) * height / 2);

            let v2x =  Math.round((-v2[0]+1) * width / 2);
            let v2y =  Math.round((-v2[1]+1) * height / 2);


            drawTriangle({x:v0x,y:v0y},{x:v1x,y:v1y},{x:v2x,y:v2y},imageData,
                [Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255),255])
        }
    }


    function drawModel3(imageData,width,height){
        const lightVer = [0,0,-1];
        const zBuffer = new Array(width*height);
        for(let i=0;i<objDataArray.faces.length;i++){
            let face = objDataArray.faces[i];

            let v0 = objDataArray.verts[face[0]];
            let v1 = objDataArray.verts[face[(1)]];
            let v2 = objDataArray.verts[face[(2)]];

            let v0t = objDataArray.texture[face[3]].map(i=>Math.round(i*255));
            let v1t = objDataArray.texture[face[4]].map(i=>Math.round(i*255));
            let v2t = objDataArray.texture[face[5]].map(i=>Math.round(i*255));

            let v0x =  Math.round((-v0[0]+1 ) * width / 2);
            let v0y =  Math.round((-v0[1]+1 ) * height / 2 );
            let v0z =  Math.round((-v0[2]+1 ) * height / 2 );

            let v1x =  Math.round((-v1[0]+1) * width / 2);
            let v1y =  Math.round((-v1[1]+1) * height / 2);
            let v1z =  Math.round((-v1[2]+1) * height / 2);

            let v2x =  Math.round((-v2[0]+1) * width / 2);
            let v2y =  Math.round((-v2[1]+1) * height / 2);
            let v2z =  Math.round((-v2[2]+1) * height / 2);


            let n = crossProduct(verSub(v2,v0),verSub(v1,v0));
            n = normalize(n);

            let light = dot(n,lightVer);
            if(light>0){
                console.log(v2t)
                drawTriangle2({x:v0x,y:v0y,z:v0z},{x:v1x,y:v1y,z:v1z},{x:v2x,y:v2y,z:v2z},imageData,
                    [Math.round(light*255),Math.round(light*255),Math.round(light*255),255],zBuffer,[v0t,v1t,v2t]);
            }
        }
    }

    function verSub(v1,v2){
        return [v1[0]-v2[0],v1[1]-v2[1],v1[2]-v2[2]]
    }

    function crossProduct(v1,v2){
        return [
            v1[1]*v2[2]-v1[2]*v2[1],
            v1[0]*v2[2]-v1[2]*v2[0],
            v1[0]*v2[1]-v1[1]*v2[0]
        ]
    }

    function normalize(v1){
      let len = Math.sqrt(v1[0]*v1[0]+v1[1]*v1[1]+v1[2]*v1[2]);
      return [
          v1[0]/len,  v1[1]/len,  v1[2]/len
      ]
    }

    function dot(v1,v2){
        return v1[0]*v2[0]+v1[1]*v2[1]+v1[2]*v2[2];
    }

    main();
</script>
</body>
</html>